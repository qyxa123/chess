# OTBReview - å®ä½“æ£‹ç›˜è§†é¢‘åˆ†æç³»ç»Ÿ

å°†å®ä½“æ£‹ç›˜è§†é¢‘è½¬æ¢ä¸ºPGNï¼Œå¹¶ä½¿ç”¨Stockfishè¿›è¡Œå¤ç›˜åˆ†æã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸ“¹ **è§†é¢‘è§£æ**ï¼šè‡ªåŠ¨ä»è§†é¢‘ä¸­æŠ½å–ç¨³å®šå±€é¢å¸§
- ğŸ¯ **æ£‹ç›˜å®šä½**ï¼šæ”¯æŒArUco/AprilTagæ ‡è®°æˆ–çº¯è§†è§‰æ£€æµ‹
- â™Ÿï¸ **èµ°æ³•è¯†åˆ«**ï¼šåŸºäºåˆæ³•æ€§çº¦æŸçš„è§£ç ç®—æ³•
- ğŸ§  **Stockfishåˆ†æ**ï¼šæœ¬åœ°ç¦»çº¿åˆ†æï¼Œæ— éœ€ä¼šå‘˜
- ğŸ“Š **å¯è§†åŒ–å¤ç›˜**ï¼šä»¿chess.comé£æ ¼çš„ç½‘é¡µå¤ç›˜ç•Œé¢
- ğŸ”§ **çº é”™æœºåˆ¶**ï¼šä½ç½®ä¿¡åº¦èµ°æ³•å¯æ‰‹åŠ¨ä¿®æ­£

## å¿«é€Ÿå¼€å§‹

### å‰ç½®è¦æ±‚

- macOS (æ¨è)
- Python 3.8+
- Stockfish (é€šè¿‡brewå®‰è£…)
- ffmpeg (ç”¨äºè§†é¢‘å¤„ç†)

### å®‰è£…æ­¥éª¤

1. **å®‰è£…ç³»ç»Ÿä¾èµ–**
```bash
brew install stockfish ffmpeg
```

2. **å…‹éš†ä»“åº“**
```bash
git clone https://github.com/qyxa123/chess.git
cd chess
```

3. **åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ**
```bash
python3 -m venv venv
source venv/bin/activate  # macOS/Linux
```

4. **å®‰è£…Pythonä¾èµ–**
```bash
pip install -r requirements.txt
```

### ä½¿ç”¨æ–¹æ³•

#### Debug Pipeline Quickstartï¼ˆæ¨èå…ˆè¿è¡Œï¼‰

**ä¸€é”®æµ‹è¯•ä»è§†é¢‘åˆ°debugè¾“å‡ºçš„æµç¨‹ï¼š**

```bash
# å®‰è£…ä¾èµ–
pip install -r requirements_computer.txt

# è¿è¡Œdebug pipelineï¼ˆè‡ªåŠ¨æŸ¥æ‰¾è§†é¢‘æ–‡ä»¶ï¼‰
python scripts/run_debug_pipeline.py --outdir out/debug_run --use_markers 1

# æˆ–æŒ‡å®šè§†é¢‘æ–‡ä»¶
python scripts/run_debug_pipeline.py --input IMG_4504.MOV --outdir out/debug_run --use_markers 1
```

**éªŒæ”¶æ ‡å‡†ï¼š**
1. æŸ¥çœ‹ `out/debug_run/debug/grid_overlay.png` - ç½‘æ ¼çº¿åº”è¯¥è´´åˆæ£‹ç›˜æ ¼
2. æŸ¥çœ‹ `out/debug_run/debug/aruco_preview.png` - åº”è¯¥çœ‹åˆ°4ä¸ªæ ‡è®°ï¼ˆID 0,1,2,3ï¼‰è¢«æ£€æµ‹åˆ°
3. æŸ¥çœ‹ `out/debug_run/debug/warped_boards/` - çŸ«æ­£åçš„æ£‹ç›˜åº”è¯¥æ˜¯æ­£å¯¹ã€æ— é€è§†ç•¸å˜
4. æŸ¥çœ‹ `out/debug_run/debug/stable_frames/` - åº”è¯¥æœ‰å¤šå¼ ç¨³å®šå¸§
5. æŸ¥çœ‹ `out/debug_run/debug/motion.csv` - è¿åŠ¨æ•°æ®è®°å½•

**å¦‚æœgrid_overlay.pngçš„ç½‘æ ¼ä¸è´´åˆï¼š**
- æ£€æŸ¥ArUcoæ ‡è®°æ˜¯å¦æ¸…æ™°å¯è§
- æ£€æŸ¥æ ‡è®°æ˜¯å¦è´´åœ¨æ£‹ç›˜å››è§’ï¼ˆID 0=å·¦ä¸Š, 1=å³ä¸Š, 2=å³ä¸‹, 3=å·¦ä¸‹ï¼‰
- è°ƒæ•´æ‹æ‘„è§’åº¦ï¼Œç¡®ä¿æ ‡è®°ä¸è¢«é®æŒ¡

#### ä»Warpedæ£‹ç›˜å¸§è§£ç PGN

**ä»å·²çŸ«æ­£çš„æ£‹ç›˜å›¾åƒç”ŸæˆPGNï¼š**

```bash
python scripts/run_decode_pgn.py --warped_dir out/debug_run/debug/warped_boards --outdir out/pgn_decode
```

**å¯é€‰å‚æ•°ï¼š**
- `--uncertain_threshold 0.1`ï¼šä¸ç¡®å®šé˜ˆå€¼ï¼ˆtop1ä¸top2è·ç¦»å·®è·ï¼Œé»˜è®¤0.1ï¼‰
- `--dist_threshold 2.0`ï¼šè·ç¦»é˜ˆå€¼ï¼ˆè¶…è¿‡æ­¤å€¼åˆ™ä¸ç¡®å®šï¼Œé»˜è®¤2.0ï¼‰

**è¾“å‡ºæ–‡ä»¶ï¼š**
- `board_states.json` - æ¯å¸§çš„8x8 labelsï¼ˆempty/light/darkï¼‰+ confidence
- `game.pgn` - æ¨æ–­çš„å®Œæ•´PGNï¼ˆSANæ ¼å¼ï¼‰
- `debug/occupancy_maps/` - æ¯å¸§çš„å ç”¨å›¾å¯è§†åŒ–
- `debug/diff_heatmaps/` - ç›¸é‚»å¸§å·®åˆ†çƒ­åŠ›å›¾
- `debug/uncertain_moves.json` - ä½ç½®ä¿¡åº¦æ­¥çš„å€™é€‰èµ°æ³•
- `debug/cells/` - ç¬¬ä¸€å¸§çš„æ¯æ ¼åˆ‡ç‰‡ï¼ˆç”¨äºæ£€æŸ¥åˆ†ç±»ï¼‰

**éªŒæ”¶æ–¹å¼ï¼š**
1. æŸ¥çœ‹ `debug/occupancy_maps/occupancy_map_0000.png` - åº”è¯¥æ˜¾ç¤ºæ ‡å‡†å¼€å±€ï¼ˆç¬¬ä¸€ã€äºŒè¡Œå’Œç¬¬ä¸ƒã€å…«è¡Œæœ‰æ£‹å­ï¼‰
2. æŸ¥çœ‹ `debug/cells/` - æ£€æŸ¥æ¯æ ¼åˆ†ç±»æ˜¯å¦æ­£ç¡®
3. æ‰“å¼€ `game.pgn` åœ¨ç½‘é¡µå›æ”¾ä¸­éªŒè¯èµ°æ³•æ˜¯å¦åˆç†
4. å¦‚æœæœ‰å¤šæ­¥ä¸ç¡®å®šï¼ŒæŸ¥çœ‹ `debug/uncertain_moves.json` æ£€æŸ¥å€™é€‰èµ°æ³•

#### åˆ†æå•ä¸ªè§†é¢‘ï¼ˆå®Œæ•´æµç¨‹ï¼‰

```bash
python -m otbreview analyze --input video.mp4 --outdir out/game1
```

**å¯é€‰å‚æ•°ï¼š**
- `--use_markers 1`ï¼šä½¿ç”¨ArUco/AprilTagæ ‡è®°ï¼ˆéœ€åœ¨æ£‹ç›˜å››è§’è´´æ ‡è®°ï¼‰
- `--depth 16`ï¼šStockfishåˆ†ææ·±åº¦ï¼ˆé»˜è®¤14ï¼‰
- `--pv 6`ï¼šä¸»å˜PVé•¿åº¦ï¼ˆé»˜è®¤6ï¼‰

#### ç›‘æ§inboxç›®å½•ï¼ˆè‡ªåŠ¨å¤„ç†ï¼‰

```bash
python -m otbreview watch --inbox ~/OTBReview/inbox --outroot ~/OTBReview/output
```

å½“æ–°è§†é¢‘æ”¾å…¥inboxç›®å½•æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç†ã€‚

### è¾“å‡ºç»“æœ

åˆ†æå®Œæˆåï¼Œåœ¨è¾“å‡ºç›®å½•ä¸­ä¼šç”Ÿæˆï¼š

- `game.pgn` - æ ‡å‡†PGNæ ¼å¼æ£‹å±€
- `analysis.json` - è¯¦ç»†åˆ†ææ•°æ®ï¼ˆæ¯æ­¥evalã€åˆ†ç±»ã€PVç­‰ï¼‰
- `index.html` - ç½‘é¡µå¤ç›˜ç•Œé¢ï¼ˆåŒå‡»æ‰“å¼€ï¼‰
- `debug/` - è°ƒè¯•ä¸­é—´ç»“æœ
  - `stable_frames/` - æŠ½å–çš„ç¨³å®šå¸§
  - `warped_boards/` - é€è§†çŸ«æ­£åçš„æ£‹ç›˜
  - `grid_overlay.png` - ç½‘æ ¼è¦†ç›–å›¾
  - `cells/` - æ¯æ ¼åˆ‡ç‰‡
  - `step_confidence.json` - æ¯æ­¥ç½®ä¿¡åº¦

## ç½‘é¡µå¤ç›˜åŠŸèƒ½

æ‰“å¼€ `index.html` åï¼Œä½ å¯ä»¥ï¼š

- âœ… **æ£‹ç›˜å›æ”¾**ï¼šç‚¹å‡»èµ°æ³•åˆ—è¡¨è·³è½¬åˆ°ä»»æ„æ­¥
- âœ… **Eval Bar + Graph**ï¼šæŸ¥çœ‹è¯„ä¼°å€¼å˜åŒ–æ›²çº¿
- âœ… **èµ°æ³•åˆ†ç±»**ï¼šBest/Good/Inaccuracy/Mistake/Blunder/Book
- âœ… **å…³é”®èµ°æ³•**ï¼šNextæŒ‰é’®åªè·³è½¬å…³é”®ç‚¹
- âœ… **Show Follow-up**ï¼šå±•ç¤ºStockfish PVï¼ˆ3-6æ­¥ï¼‰
- âœ… **çº é”™åŠŸèƒ½**ï¼šä½ç½®ä¿¡åº¦èµ°æ³•å¯æ‰‹åŠ¨é€‰æ‹©æ­£ç¡®èµ°æ³•

## å‚æ•°è°ƒä¼˜æŒ‡å—

### è§†é¢‘æ‹æ‘„å»ºè®®

- **å›ºå®šä¿¯æ‹**ï¼šiPhoneå›ºå®šä½ç½®ï¼Œå‚ç›´ä¿¯æ‹æ£‹ç›˜
- **å…‰ç…§å‡åŒ€**ï¼šé¿å…å¼ºçƒˆé˜´å½±å’Œåå…‰
- **æ£‹ç›˜æ¸…æ™°**ï¼šç¡®ä¿æ£‹ç›˜è¾¹ç•Œæ¸…æ™°å¯è§
- **æ ‡è®°å¢å¼º**ï¼ˆå¯é€‰ï¼‰ï¼šåœ¨æ£‹ç›˜å››è§’è´´ArUco/AprilTagæ ‡è®°å¯æé«˜å®šä½ç²¾åº¦

### å¯è°ƒå‚æ•°

åœ¨ä»£ç ä¸­å¯è°ƒæ•´çš„å‚æ•°ï¼š

- **motion_threshold** (extract.py)ï¼šè¿åŠ¨æ£€æµ‹é˜ˆå€¼ï¼Œé»˜è®¤0.01
  - å€¼è¶Šå°ï¼Œå¯¹è¿åŠ¨è¶Šæ•æ„Ÿ
- **stable_duration** (extract.py)ï¼šç¨³å®šæŒç»­æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œé»˜è®¤0.5
  - å€¼è¶Šå¤§ï¼Œè¦æ±‚ç¨³å®šæ—¶é—´è¶Šé•¿
- **åˆ†ç±»é˜ˆå€¼** (classify.py)ï¼šBest/Good/Inaccuracy/Mistake/Blunderçš„cp lossé˜ˆå€¼

## é¡¹ç›®ç»“æ„

```
chess/
â”œâ”€â”€ otbreview/              # ä¸»åŒ…
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ cli.py              # ç»Ÿä¸€CLIæ¥å£
â”‚   â”œâ”€â”€ pipeline/           # å¤„ç†æµç¨‹
â”‚   â”‚   â”œâ”€â”€ extract.py      # ç¨³å®šå¸§æŠ½å–
â”‚   â”‚   â”œâ”€â”€ board_detect.py # æ£‹ç›˜å®šä½
â”‚   â”‚   â”œâ”€â”€ pieces.py       # æ£‹å­è¯†åˆ«
â”‚   â”‚   â”œâ”€â”€ decode.py       # åˆæ³•æ€§çº¦æŸè§£ç 
â”‚   â”‚   â”œâ”€â”€ pgn.py          # PGNç”Ÿæˆ
â”‚   â”‚   â”œâ”€â”€ analyze.py      # Stockfishåˆ†æ
â”‚   â”‚   â”œâ”€â”€ classify.py     # èµ°æ³•åˆ†ç±»
â”‚   â”‚   â”œâ”€â”€ keymoves.py     # å…³é”®èµ°æ³•è¯†åˆ«
â”‚   â”‚   â”œâ”€â”€ main.py         # ä¸»æµç¨‹
â”‚   â”‚   â””â”€â”€ watcher.py      # ç›®å½•ç›‘æ§
â”‚   â””â”€â”€ web/                # ç½‘é¡µç”Ÿæˆ
â”‚       â””â”€â”€ generate.py     # HTMLç”Ÿæˆ
â”œâ”€â”€ scripts/                # å·¥å…·è„šæœ¬
â”œâ”€â”€ tests/                  # æµ‹è¯•
â”œâ”€â”€ requirements.txt        # Pythonä¾èµ–
â””â”€â”€ README.md              # æœ¬æ–‡æ¡£
```

## å¼€å‘çŠ¶æ€

### å·²å®Œæˆï¼ˆé˜¶æ®µ0ï¼‰
- âœ… é¡¹ç›®ç»“æ„é‡æ„
- âœ… ç»Ÿä¸€CLIæ¥å£
- âœ… æ¨¡å—åŒ–è®¾è®¡

### è¿›è¡Œä¸­ï¼ˆé˜¶æ®µ1-3ï¼‰
- ğŸš§ ç¨³å®šå¸§æŠ½å–ï¼ˆåŸºç¡€å®ç°ï¼‰
- ğŸš§ æ£‹ç›˜å®šä½ï¼ˆåŸºç¡€å®ç°ï¼ŒArUcoå¾…å®Œå–„ï¼‰
- ğŸš§ æ£‹å­è¯†åˆ«ï¼ˆåŸºç¡€å®ç°ï¼‰
- ğŸš§ åˆæ³•æ€§çº¦æŸè§£ç ï¼ˆæ ¸å¿ƒç®—æ³•ï¼‰
- ğŸš§ ç½‘é¡µå¤ç›˜ï¼ˆåŸºç¡€æ¡†æ¶ï¼‰

### å¾…å®Œå–„
- â³ ArUco/AprilTagå®Œæ•´æ”¯æŒ
- â³ æ›´ç²¾ç¡®çš„æ£‹å­è¯†åˆ«
- â³ å®Œæ•´çš„ç½‘é¡µå¤ç›˜åŠŸèƒ½ï¼ˆæ£‹ç›˜æ¸²æŸ“ã€PVæ’­æ”¾ã€Retryç­‰ï¼‰
- â³ çº é”™æœºåˆ¶çš„å‰ç«¯å®ç°

## è´¡çŒ®

æ¬¢è¿æäº¤Issueå’ŒPull Requestï¼

## è®¸å¯è¯

[å¾…å®š]
